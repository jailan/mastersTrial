<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title> Maze Game</title>
	<link href="main.css"rel="stylesheet"type="text/css"/>
	<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <%= content_tag :div, class: "temp_information", data: {temp: @tempmaze} do %>
<% end %>
</head>
<body  background="/assets/paper.jpg" onload="start();">

	<div><img id="arrow"src="/assets/maze/garrowd.png"  height="50" width="30" class="spacer"></div>    
	<div id="navContent"> 
		<div id="game1"></div>
		<div id="game2"></div>
	</div>


	<canvas width="420" height="445" id="mazecanvas" dir="rtl">Can't load the maze game, because your browser doesn't support HTML5.</canvas>
	<canvas width="420" height="445" id="questioncanvas" dir="rtl">Can't load the maze game, because your browser doesn't support HTML5.</canvas>
	<div id="score"></div>
	<div> <img class="alarm"src="/assets/maze/alarm.png"  height="40" width="40"><div id="time"></div> </div>

    <%= button_to "Home", games_home_path, {:class => "button orange", :id => "home"} %>


  <style>
	html, body {
		width:100%;
		height:100%;
		position:relative;
		margin: 0;
		padding-top: 300;
		background-image:url(/assets/paper.jpg);
		font-family: Arial, Helvetica, sans-serif;
	}
    #home{
    position:absolute;
    top:0px;
    left:80px;
    margin-top: 80px;
}


    .button {
        display: inline-block;
        outline: none;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        font: 14px/100% Arial, Helvetica, sans-serif;
        padding: .5em 2em .55em;
        text-shadow: 0 1px 1px rgba(0,0,0,.3);
        -webkit-border-radius: .5em; 
        -moz-border-radius: .5em;
        border-radius: .5em;
        -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2);
        -moz-box-shadow: 0 1px 2px rgba(0,0,0,.2);
        box-shadow: 0 1px 2px rgba(0,0,0,.2);
        float:right;
        margin-right: 20px;
        width:90px;



    }
    .orange {
        color: #fef4e9;
        border: solid 1px #da7c0c;
        background: #f78d1d;
        background: -webkit-gradient(linear, left top, left bottom, from(#faa51a), to(#f47a20));
        background: -moz-linear-gradient(top,  #faa51a,  #f47a20);
        filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#faa51a', endColorstr='#f47a20');
    }
    .orange:hover {
        background: #f47c20;
        background: -webkit-gradient(linear, left top, left bottom, from(#f88e11), to(#f06015));
        background: -moz-linear-gradient(top,  #f88e11,  #f06015);
        filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#f88e11', endColorstr='#f06015');
    }
    .orange:active {
        color: #fcd3a5;
        background: -webkit-gradient(linear, left top, left bottom, from(#f47a20), to(#faa51a));
        background: -moz-linear-gradient(top,  #f47a20,  #faa51a);
        filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#f47a20', endColorstr='#faa51a');
    }


    .button:hover {
        text-decoration: none;
    }
    .button:active {
        position: relative;
        top: 1px;
    }

	#navContent{
		position:relative;
		margin-left:380px;	
		width:800px;
		height:250px;
		padding-left: 100px;
		/*right:-700px;*/
		/*position:relative;*/
		overflow:hidden;
	}

	#game1{
		margin:auto;
		width:400px;
		height:400px;
		right:0px;
		position:absolute;

	}

	#game2{
		margin:auto;	
		width:400px;
		height:400px;
		right:-800px;
		position:absolute;

	} 



	
	.questionText{
		font-size:40px;
		color:#006;
	}


	.resultText{
		width:900px;
		font-size:20px;
		color:#006;
		margin-right:880px;
	}

	.pix{
		width:86px;
		height:86px;
		margin:15px;
		float:left;
		border: 3px solid #B8008A;
		cursor:pointer;
	}
    .pixie{
        width:86px;
        height:86px;
        margin-right: 180px;
        margin-left:245px;
        float:right;
        border: 3px solid #FC0;
     
    }

	.clicked{
		border:#FC0 solid 4px;
	}

	.pix:hover{
		border:#FC0 solid 4px;
	}
	.pix:active{
		border:#FC0 solid 4px;
	}
	.pix:target{
		border:#FC0 solid 4px;
	}


	#arrow{


		margin-left:25px;
        margin-top: 5px;

	}

	#topbar{
		height:100px;
		margin:auto;
		margin-top:50px;
		color:#FFF;
		font-size:36px;
		font-family:Arial, Helvetica, sans-serif;
		width:800px;
	}
	
	.spacer{
		height:50px;
		margin-top: -40px;
	}
	.feedback1{
		width:120px;
		padding:5px;
		font-size:20px;
		color:#FFFFCC;
		background-color:#009900;
		font-family:Arial, Helvetica, sans-serif;
		text-align:center;
		position:absolute;
		top:200px;
		right:180px;
	}

	.feedback2{
		width:150px;
		padding:5px;
		font-size:20px;
		color:#FFFFCC;
		background-color:#CC3300;
		font-family:Arial, Helvetica, sans-serif;
		text-align:center;
		position:absolute;
		top:200px;
		right:180px;
	}
	h1 {
		text-align: center;
		font-family: Tahoma, Geneva, sans-serif;
		color:#006;
		font-size: 40px;
	}
/*div {
    font-size: 30px;
    color: #006;
    padding-top: 0px;
    padding-left:980px;

    }*/
    div {
    	
    	margin-top:0px;
    	margin-left:280px;


    }

    #time{
    	font-size: 25px;
    	
    	padding-top: 10px;
    	padding-left:445px;
    }
    .alarm{

    	margin-left: 730px;
    	margin-top: 150px;

    }


    #score{
    	font-size: 25px;
    	color: #B8008A;
    	padding-top: 10px;
    	padding-left:300px;
    }
    #questioncanvas { position:absolute; 
    	top:120px;
    	width: 400px;
    	height:400px;
    	margin: 0px auto;
    	border: 1px solid #B8008A;
    	margin-left:80px; }
    	#mazecanvas { position:absolute; 
    		top:120px;
    		width: 400px;
    		height:400px;
    		margin: 0px auto;
    		border: 1px solid #B8008A;
    		margin-left:80px; }

    		#canvas-wrap {position:relative;}



    		
    		
    		@media screen and (max-width:800px) {
    			#topbar{margin-left:1%;margin-right:1%;	width:98%;}
    			#navContent{margin:1%;	width:98%;}
    			#game1{margin:1%;	width:98%;}
    			#game2{margin:1%;	width:98%;}


    		}
    		@media screen and (max-width:400px) {
    			.pix{margin:1px;margin-top:10px;}


    		}
    		</style>

    		




    		<noscript>JavaScript is not enabled. To play the game, you should enable it.</noscript>
    		<script type='text/javascript' > 
            var ON_BORDER = 0;
            var ON_BLANK_SPACE = 1;
            var ON_END_OF_MAZE = 2;
            var ON_QUESTION = 3;

    		var answered =0;
    		var first = 1;
    		var score = 0;
    		var subscore = 10;
            var textq="كرة";
            var mazeletter = $('.temp_information').data('temp'); 
            //alert(mazeletter);
            <%= $speech="كرة" %>

    		</script>
    		<script src="/assets/jquery.js"></script>    <script type="text/javascript" charset="utf-8">

    		var canvas = document.getElementById("mazecanvas");
    		var context = canvas.getContext("2d");
    		var dataUrl = canvas.toDataURL();
    		var myImage = canvas.toDataURL("image/png");  


    		var cnv = document.getElementById("questioncanvas");
    		var ctx = cnv.getContext("2d");
    		var currRectX = 425;
    		var currRectY = 3;
    		var mazeWidth = 556;
    		var mazeHeight = 556;
    		var intervalVar;
    		



    		/* TIMER ************************************/
    		var mins = 5;
    		var secs = 0;
    		var timer;
    		function start(){
    			timer = setInterval('update()', 1000);

    		}
    		function update(){

    			var timeField = document.getElementById('time');
    			timeField.style.color="green";
    			if(secs == 0){
    				if(mins == 0){
    					timeField.style.color= "red";
    					timeField.innerHTML = 'Time is up!';

    					clearInterval(timer);
    					//alert('Time is up');
    					return;
    				}
    				
    				secs = 59;
    				mins--;}
    				else{
    					secs--;}
    					
    					
    					if(mins <= 2){
    						timeField.style.color= "orangered";
    						timeField.innerHTML = mins + ':' + secs;
    					}  else if (mins<= 1) {
    						timeField.style.color= "red";
    						timeField.innerHTML = mins + ':' + secs;
    					}
    					else{
    						timeField.style.color="green";
    						timeField.innerHTML =  mins + ':' + secs;
    					} 
    					if(secs <10){
    						timeField.innerHTML =  mins + ':0' + secs;
    					}


    				}
    				/* TIMER ************************************/
      var obstaclesArray = [[300,36],[400,70],[400,120],[300,160],[210,160],[140,160],[24,185],[120,210],[220,210],[290,260],[195,260],[105,310],[24,340],[24,383],[50,434]];
    function drawMazeAndRectangle(rectX, rectY) {
              makeWhite(0, 0, canvas.width, canvas.height);
              var mazeImg = new Image();
              mazeImg.onload = function () {
                context.drawImage(mazeImg, -40, -10);
                drawRectangle(rectX, rectY, "#000066");
                drawStroke(89, 145, "#000000");
                drawStroke(313, 320, "#000000");
             for(w=0;w<obstaclesArray.length;w++){ 
                context.beginPath();
                context.arc(obstaclesArray[w][0], obstaclesArray[w][1], 9, 0, 2 * Math.PI, false);
                context.closePath();
                if((w+1)%3 === 0){
                 context.fillStyle = '#B8008A';   
                }
                else{
                context.fillStyle = '#FF9900'; }//orange
                //context.fillStyle = '#B8008A';//fushciac
                context.fill();
             }
                
               // new Audio('background-music.wav').play();
               // myImage = canvas.toDataURL("image/png"); 
               //window.open(dataUrl, "toDataURL() image", "width=600, height=200");
            };
            //mazeImg.src = "maze.gif";
            mazeImg.src = "/assets/maze/maze3.png";
        }
        
        function drawRectangle(x, y, style) {

        	makeWhite(currRectX, currRectY, 17, 17);
        	currRectX = x;
        	currRectY = y;
        	context.beginPath();
        	context.rect(x, y, 17, 17);
        	context.closePath();
        	context.fillStyle = style;
        	context.fill();

        }
                function drawStroke(x, y, style) {

            context.beginPath();
            context.rect(x, y, 21, 6);
            context.closePath();
            context.fillStyle = style;
            context.fill();

        }
            var correctAnswers =0;
function moveRect(e) {
	var newX=currRectX;
	var newY=currRectY;
	var location;
	e = e || window.event;
	switch (e.keyCode) {
        case 38:   // arrow up key
        case 87: // W key
        newX = currRectX;
        newY = currRectY - 3;
        break;
        case 37: // arrow left key
        case 65: // A key
        newX = currRectX - 3;
        newY = currRectY;
        break;
        case 40: // arrow down key
        case 83: // S key
        newX = currRectX;
        newY = currRectY + 3;
        break;
        case 39: // arrow right key
        case 68: // D key
        newX = currRectX +3;
        newY = currRectY;
        break;
    }

    location = canMoveTo(newX, newY);


    if (location === ON_BLANK_SPACE) {      // 1 means 'the rectangle can move'
        if(currentQuestionIsAnswered()) {
            questionNumber++;
        }
    } else if (correctAnswers === 15) { // 2 means 'the rectangle reached the end point'
    alert("khalasnaaa");
    	clearInterval(intervalVar);
        makeWhite(0, 0, canvas.width, canvas.height);
        context.font = "40px Arial";
        context.fillStyle = "#B8008A";
        context.textAlign = "center";
        context.textBaseline = "middle";

        context.fillText("Congratulations", canvas.width / 2, canvas.height / 2);
        //displayFinalSlide();

        window.removeEventListener("keydown", moveRect, true);
        clearTimeout(timer);
    } else if (location === ON_QUESTION || location === ON_END_OF_MAZE) { // 3 means 'the rectangle reached the question orange point'
        if(!currentQuestionIsAnswered()) {
            if (first === 1){
                displayQuestion();
                first =0;
            } else{

                setTimeout(function(){changeQuestion()},1000);
            }
            textq=answersBank[questionNumber][0];
            speak(textq);


            clearInterval(intervalVar);
           makeWhito(0, 0, canvas.width, canvas.height);
           ctx.font = "200px Arial";
           ctx.fillStyle = "#B8008A";
           ctx.textAlign = "center";
           ctx.textBaseline = "middle";
           var str1 = "انتي جاية اشتغلي ايه ?";
           ctx.fillText("?", canvas.width / 2, canvas.height / 2);


           myImage = canvas.toDataURL("image/png"); 

            /*makeWhite(0, 0, canvas.width, canvas.height);
            context.font = "200px Arial";
            context.fillStyle = "#B8008A";
            context.textAlign = "center";
            context.textBaseline = "middle";
            context.fillText("?", canvas.width / 2, canvas.height / 2);*/
            window.removeEventListener("keydown", moveRect, true);
        }
    }

    if (isOnMovable(location)) {
        movePiece(newX, newY)
    }
}

function movePiece(newX, newY) {
    drawRectangle(newX, newY, "#000066");
    currRectX = newX;
    currRectY = newY;
}

function isOnMovable(location) {
    return location == ON_BLANK_SPACE || location == ON_QUESTION;
}
function currentQuestionIsAnswered() {
 return questionBank[questionNumber].answered;
}

function canMoveTo(destX, destY) {
    debugger
    // myImage = canvas.toDataURL("image/png"); 
    var imgData = context.getImageData(destX, destY, 17, 17);
    var data = imgData.data;
    var canMove = ON_BLANK_SPACE; // ON_BLANK_SPACE means the rectangle can move
    if (isInMazeBounds(destX, destY)) {
    	for (var i = 0; i < 4 * 17* 17; i += 4) {
            if (isOnWall(data, i)) { // black
                canMove = ON_BORDER; // 0 means: the rectangle can't move
                break;
            } else if (isOnEndMaze(data, i)){ // #B8008A fuschiac
                canMove = ON_END_OF_MAZE; // 2 means: the end point is reached
                break;
            } else if (isOnQuestion(data, i)) {
                // #FF9900 orange
                canMove = ON_QUESTION;
                break;
           }
        }
    } else {
    	canMove = ON_BORDER;
    }


    displayScore();

    return canMove;
}

function isOnWall(data, i) {
    return data[i] === 0 && data[i + 1] === 0 && data[i + 2] === 0;
}

function isOnQuestion (data, i) {
    return data[i] === 255 && data[i + 1] === 153 && data[i + 2] === 0;
}

function isOnEndMaze(data, i) {
    return data[i] === 184 && data[i + 1] === 0 && data[i + 2] === 138;
}

function isInMazeBounds(destX, destY) {
    return destX >= 0 && destX <= mazeWidth - 15 && destY >= 0 && destY <= mazeHeight - 15;
}

       /* function createTimer(seconds) {
            intervalVar = setInterval(function () {
                makeWhite(mazeWidth, 0, canvas.width - mazeWidth, canvas.height);
                if (seconds === 0) {
                    clearInterval(intervalVar);
                    window.removeEventListener("keydown", moveRect, true);
                    makeWhite(0, 0, canvas.width, canvas.height);
                    context.font = "40px Arial";
                    context.fillStyle = "red";
                    context.textAlign = "center";
                    context.textBaseline = "middle";
                    context.fillText("Time's up!", canvas.width / 2, canvas.height / 2);
                    return;
                }
                context.font = "20px Arial";
                if (seconds <= 10 && seconds > 5) {
                    context.fillStyle = "orangered";
                }
                else if (seconds <= 5) {
                    context.fillStyle = "red";
                }
                else {
                    context.fillStyle = "green";
                }
                context.textAlign = "center";
                context.textBaseline = "middle";
                var minutes = Math.floor(seconds / 60);
                var secondsToShow = (seconds - minutes * 60).toString();
                if (secondsToShow.length === 1) {
                    secondsToShow = "0" + secondsToShow; // if the number of seconds is '5' for example, make sure that it is shown as '05'
                }
                context.fillText(minutes.toString() + ":" + secondsToShow, mazeWidth-390, canvas.height / 2 -210);
                seconds--;
            }, 1000);
}*/


function makeWhite(x, y, w, h) {

	context.beginPath();
	context.rect(x, y, w, h);
	context.closePath();
	context.fillStyle ='rgba(255, 255, 255,0.5)';
	context.fill();
}

function makeWhito(x, y, w, h) {

	ctx.beginPath();
	ctx.rect(x, y, w, h);
	ctx.closePath();
	ctx.fillStyle ='rgba(255, 255, 255,0.5)';
	ctx.fill(); 
}
var imo = new Image();


function unMakeWhite() {

	imo.src = myImage; 
	ctx.clearRect ( 0, 0, canvas.width, canvas.height );
    //context.drawImage(imo,0,0);
    //drawMazeAndRectangle(currRectX, currRectY);

}





drawMazeAndRectangle(242, 7);

window.addEventListener("keydown", moveRect, true);

    //createTimer(120*10); // 20 minutes

 


var questionNumber=0;
var questionBank=new Array();
var stage="#game1";
var stage2=new Object;
var questionLock=false;
var numberOfQuestions;
var answersBank=new Array();

$.getJSON('/assets/maze/activity'+mazeletter+'.json', function(data) {
    // THE NAME OF THE FILE IS THE ONE WHO DECIDES ACTUALLY ! (MAZELETTER)

	for(i=0;i<data.quizlist.length;i++){ 
		questionBank[i]=new Array;
		questionBank[i][0]=data.quizlist[i].question;
		questionBank[i][1]=data.quizlist[i].option1;
		questionBank[i][2]=data.quizlist[i].option2;
		questionBank[i][3]=data.quizlist[i].option3;
	}
	numberOfQuestions=questionBank.length; 

	// if (ask > 0){

	// 	displayQuestion();}

})//gtjson


   // fillDB();
$.getJSON('/assets/maze/activityanswers'+mazeletter+'.json', function(data) {
//WE ONLY CARE ABOUT THE FIRST ANSWER (AUDIO)

    for(i=0;i<data.answerslist.length;i++){ 
        answersBank[i]=new Array;
        answersBank[i][0]=data.answerslist[i].question;
        answersBank[i][1]=data.answerslist[i].option1;
        answersBank[i][2]=data.answerslist[i].option2;
        answersBank[i][3]=data.answerslist[i].option3;
    }
    //numberOfQuestions=questionBank.length; 

    //if (ask > 0){

        //displayQuestion();}

})//gtjson


fillDB();


function displayQuestion(){
	var rnd=Math.random()*3;
	rnd=Math.ceil(rnd);
	var q1;
	var q2;
	var q3;
    var q0= questionBank[questionNumber][0];


	if(rnd==1){q1=questionBank[questionNumber][1];q2=questionBank[questionNumber][2];q3=questionBank[questionNumber][3];}
	if(rnd==2){q2=questionBank[questionNumber][1];q3=questionBank[questionNumber][2];q1=questionBank[questionNumber][3];}
	if(rnd==3){q3=questionBank[questionNumber][1];q1=questionBank[questionNumber][2];q2=questionBank[questionNumber][3];}

    $(stage).append('<div class="pixie"><img src="/assets/maze/l'+mazeletter+'/'+q0+'"></div>');
    $(stage).append('<div id="1" class="pix"><img src="/assets/maze/l'+mazeletter+'/'+q1+'"></div><div id="2" class="pix"><img src="/assets/maze/l'+mazeletter+'/'+q2+'"></div><div id="3" class="pix"><img src="/assets/maze/l'+mazeletter+'/'+q3+'"></div>');

        	/*$(stage).append('<div  class="questionText">'+questionBank[questionNumber][0]+'</div><div id="1" class="pix"><img src="/assets/'+q1+'"></div><div id="2" class="pix"><img src="/assets/'+q2+'"></div><div id="3" class="pix"><img src="/assets/'+q3+'"></div>');*/
         
        
           /*  $(document).ready(function(){
      $('button').click(function(){
           $(this).addClass('clicked');
      });
}); */

$('.pix').click(function(){
	$(this).addClass('clicked');
	
	if(questionLock==false){questionLock=true;    
  //correct answer
  if(this.id==rnd){
  var texti=answersBank[questionNumber][1];
   //getSpeech(texti);
   speak(texti);
  // getSpeechy(texti);
  // new Audio('/assets/lalazy.mp3').play();
  	$(stage).append('<div class="feedback1">CORRECT</div>');
  	unMakeWhite();
  	answered = 1;
    correctAnswers ++;
    // COLORING THE CORRECTLY ANSWERED QUESTION
  	    context.beginPath();
        context.arc(obstaclesArray[questionNumber][0], obstaclesArray[questionNumber][1], 9, 0, 2 * Math.PI, false);
        context.closePath();
        context.fillStyle = '#75A319';//orange
        context.fill();
  	score=score+subscore;
  	subscore=10;

 // if(correctAnswers %3 === 0){
 //     new Audio('/assets/applause.mp3').play();}

 if(correctAnswers === 15){
            clearInterval(intervalVar);
        makeWhite(0, 0, canvas.width, canvas.height);
        context.font = "40px Arial";
        context.fillStyle = "#B8008A";
        context.textAlign = "center";
        context.textBaseline = "middle";

        context.fillText("Congratulations", canvas.width / 2, canvas.height / 2);
        //displayFinalSlide();
        new Audio('/assets/applause.mp3').play();
        window.removeEventListener("keydown", moveRect, true);
        clearTimeout(timer);

 }
 
  	window.addEventListener("keydown", moveRect, true);

  	movingAllowed =0;
    questionBank[questionNumber].answered = true;
  	// questionNumber++;
 

  }
  //wrong answer    
  if(this.id!=rnd){
  	$(stage).append('<div class="feedback2">WRONG</div>');
  	//new Audio('/assets/no.mp3').play();
    new Audio('/assets/boing.wav').play();

  	subscore-=3 ;
  	setTimeout(function(){changeQuestion()},1000); 

  }
 // setTimeout(function(){changeQuestion()},1000); 
}});

}//display question


function changeQuestion(){


	if(stage=="#game1"){stage2="#game1";stage="#game2";}
	else{stage2="#game2";stage="#game1";}
	
	if(questionNumber<numberOfQuestions){displayQuestion();}else{displayFinalSlide();}
	
	$(stage2).animate({"right": "+=800px"},"slow", function() {$(stage2).css('right','-800px');$(stage2).empty();});
	$(stage).animate({"right": "+=800px"},"slow", function() {questionLock=false;});
    }//change question

    


    
    function displayFinalSlide(){

        //$(stage).append('<div class="questionText">You can Go!<br><br>Total questions: '+numberOfQuestions+'<br>Correct answers: '+score+'</div>');
        $(stage).append('<div id="score" class="resultText">You can Go!<br><br>Score: '+score+'/'+numberOfQuestions);

        
    }//display final slide

    function displayScore(){
    	var scoreField = document.getElementById('score');
    	scoreField.innerHTML = 'Score: '+score+' / '+'70';


    }

     function getSpeech(fieldClicked) {
    $.ajax({
        url: 'ool',
        type: 'get',
        contentType: 'application/json; charset=UTF-8',
        accept: 'application/json',
        dataType: 'json',
        data: {speech:fieldClicked}
    
    });
};

function speak(word){
var msg = new SpeechSynthesisUtterance();
msg.volume = 1; // 0 to 1
msg.rate = 1; // 0.1 to 10
msg.pitch = 1; //0 to 2
msg.text = word;
msg.lang = 'ar';

msg.onend = function(e) {
  console.log('Finished in ' + event.elapsedTime + ' seconds.');
};

speechSynthesis.speak(msg);
}


    </script>

    <script src="soundmanager2.js"></script>
<script>
     function getSpeechy(fieldClicked) {

soundManager.setup({
  url: '/assets/',
  onready: function() {

    var mySound = soundManager.createSound({
      id: 'aSound',
      url: '/assets/lalazy.mp3'
    });
    mySound.play();
  },
  ontimeout: function() {
    // Hrmm, SM2 could not start. Missing SWF? Flash blocked? Show an error, etc.?
  }
});
};





</script>
</body>
</html>
